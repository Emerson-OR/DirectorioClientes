{% extends "base.html" %}
{% block title %}Clientes · Lista{% endblock %}
{% block content %}

{% load static %}

<!-- Estilos y decoraciones del tema (sin duplicar header del base) -->
<style>
  @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap");
  body { font-family: "Inter", sans-serif; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
  .float-anim{animation:float 6s ease-in-out infinite}
  .card-hover{transition:all .3s ease}
  .card-hover:hover{transform:translateY(-8px);box-shadow:0 20px 60px rgba(251,191,36,.3)}
</style>

<!-- fondo decorativo -->
<div class="fixed inset-0 pointer-events-none overflow-hidden">
  <div class="float-anim absolute top-1/4 left-1/4 w-96 h-96 bg-amber-500/20 rounded-full blur-[130px]"></div>
  <div class="float-anim absolute bottom-1/4 right-1/4 w-[500px] h-[500px] bg-yellow-600/15 rounded-full blur-[150px]" style="animation-delay:2s"></div>
</div>
<div class="fixed inset-0 pointer-events-none opacity-[0.02]" style="background-image: linear-gradient(rgba(251, 191, 36, 0.5) 1px, transparent 1px), linear-gradient(90deg, rgba(251, 191, 36, 0.5) 1px, transparent 1px); background-size:50px 50px;"></div>

<!-- Barra de acciones de administrador (sin duplicar header) -->
<div class="relative z-10 max-w-7xl mx-auto px-4 pt-6">
  {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
  <div class="flex gap-3 flex-wrap justify-end mb-4">
    <a href="{% url 'agregar_cliente' %}" class="group relative overflow-hidden bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold py-2.5 px-4 rounded-xl shadow-lg hover:from-amber-600 hover:to-amber-700 transition-all">
      <span class="relative inline-flex items-center gap-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
        Agregar Cliente
      </span>
    </a>
    <a href="{% url 'clientes_eliminados' %}" class="group relative overflow-hidden bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold py-2.5 px-4 rounded-xl shadow-lg hover:from-amber-600 hover:to-amber-700 transition-all">
      <span class="inline-flex items-center gap-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M10 10v8M14 10v8M9 6l1-2h4l1 2"/></svg>
        Ver eliminados
      </span>
    </a>
    <a href="{% url 'crear_usuario' %}" class="group relative overflow-hidden bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold py-2.5 px-4 rounded-xl shadow-lg hover:from-amber-600 hover:to-amber-700 transition-all">
      <span class="inline-flex items-center gap-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 8v6M16 11h6"/></svg>
        Crear usuario
      </span>
    </a>
    <a href="{% url 'usuarios_creados' %}" class="group relative overflow-hidden bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold py-2.5 px-4 rounded-xl shadow-lg hover:from-amber-600 hover:to-amber-700 transition-all">
      <span class="inline-flex items-center gap-2">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 8v6M16 11h6"/></svg>
        Usuarios creados
      </span>
    </a>
  </div>
  
  {# Modales de eliminación fuera de las tarjetas para evitar romper el layout #}
  {% for cliente in page_obj %}
    {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
    <div id="eliminarClienteModal{{ cliente.pk }}" class="fixed inset-0 z-50 hidden" style="z-index:9999999 !important;">
      <div class="absolute inset-0 bg-black/60" style="z-index:9999998 !important;" onclick="document.getElementById('eliminarClienteModal{{ cliente.pk }}').classList.add('hidden')"></div>
      <div class="flex items-center justify-center min-h-screen p-4" style="z-index:9999999 !important;">
        <div class="w-full max-w-2xl" role="dialog" aria-modal="true">
          <div style="position:relative; z-index:10000001; background: #1a1a1d; color: #f5f5f5; border: 1px solid rgba(217, 119, 6, 0.4); border-radius: 1.5rem; box-shadow: 0 0 25px rgba(217, 119, 6, 0.15);">
            <form method="POST" action="{% url 'eliminar_cliente' cliente.pk %}" onsubmit="return validarEliminacion{{ cliente.pk }}()">
              {% csrf_token %}
              <div style="border-bottom: 1px solid rgba(217, 119, 6, 0.3); padding: 1rem 1.25rem; display:flex; align-items:center; justify-content:space-between;">
                <h5 style="color: #eab308; font-weight: 700; letter-spacing: 0.5px; margin:0;">⚠️ Eliminar Cliente</h5>
                <button type="button" onclick="document.getElementById('eliminarClienteModal{{ cliente.pk }}').classList.add('hidden')" style="background:transparent;border:none;color:#f5f5f5;font-size:1.1rem;padding:0.25rem 0.5rem;">✕</button>
              </div>

              <div style="padding:1rem 1.25rem;">
                <div style="background: rgba(234, 179, 8, 0.08); border: 1px solid rgba(234, 179, 8, 0.25); border-radius: 0.75rem; padding: 1.25rem;">
                  <p class="mb-3" style="font-weight: 600; color: #f1f1f1; margin:0 0 0.5rem;">⚠️ Esta acción no se puede deshacer.</p>
                  <p class="mb-3" style="color: #d4d4d8; margin:0 0 0.5rem;">Estás a punto de eliminar al cliente:</p>
                  <p style="color: #facc15; font-size: 1.15rem; font-weight: 700; text-transform: capitalize; margin:0 0 0.5rem;">{{ cliente.nombre }}</p>
                  <p class="mb-0" style="color: #c1c1c1; margin:0;">ID: <strong style="color: #facc15;">{{ cliente.identificacion }}</strong></p>
                </div>

                <div class="mb-3 mt-4">
                  <label class="form-label" style="color: #eab308; font-weight: 600; display:block; margin-bottom:0.5rem;">
                    Para confirmar, escribe <span style="background: rgba(234, 179, 8, 0.15); padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-family: monospace; color: #fde68a;">eliminar</span> en el campo de abajo:
                  </label>
                  <input type="text" name="confirmacion" id="confirmacion{{ cliente.pk }}" placeholder="Escribe: eliminar" style="width:100%; background:#2a2a2e; color:#fff; border:1.8px solid rgba(234,179,8,0.4); border-radius:0.75rem; padding:0.5rem;" autocomplete="off" required onfocus="this.style.border='1.8px solid rgba(234,179,8,0.7)'" onblur="this.style.border='1.8px solid rgba(234,179,8,0.4)'" />
                </div>
              </div>

              <div style="border-top:1px solid rgba(234,179,8,0.25); padding:0.75rem 1.25rem; display:flex; gap:0.5rem; justify-content:flex-end;">
                <button type="button" onclick="document.getElementById('eliminarClienteModal{{ cliente.pk }}').classList.add('hidden')" class="px-4 py-2 rounded-md" style="background:transparent;color:#f5f5f5;border:1px solid rgba(255,255,255,0.04);">Cancelar</button>
                <button type="submit" class="px-4 py-2 fw-bold" style="background: linear-gradient(135deg, #eab308, #d97706); color:#000; border:none; font-weight:700; letter-spacing:0.3px;">Eliminar definitivamente</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      function validarEliminacion{{ cliente.pk }}(){
        const val = document.getElementById('confirmacion{{ cliente.pk }}').value.trim().toLowerCase();
        if(val !== 'eliminar'){
          alert('⚠️ Debes escribir exactamente "eliminar" para confirmar.');
          document.getElementById('confirmacion{{ cliente.pk }}').focus();
          return false;
        }
        return true;
      }
    </script>
    {% endif %}
  {% endfor %}

  <script>
    // Mueve los modales de eliminación al final del <body> para evitar stacking-contexts
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var modals = document.querySelectorAll('[id^="eliminarClienteModal"]');
        modals.forEach(function(m){
          // ensure style priority
          m.style.zIndex = '9999999';
          // move to body so it's outside any transformed/stacked ancestor
          document.body.appendChild(m);
        });
      }catch(e){
        console.warn('No se pudieron mover los modales:', e);
      }
    });
  </script>
  {% endif %}
</div>

<!-- Barra de búsqueda -->
<div class="relative z-10 max-w-7xl mx-auto px-4">
  <div class="relative bg-zinc-950/80 backdrop-blur-xl border-2 border-amber-500/20 rounded-2xl p-6 mb-8 shadow-xl">
    <form class="flex flex-col gap-4" role="search" method="get" action="">
      <div class="flex flex-col md:flex-row gap-3">
        <div class="relative">
          <select name="field" class="w-full md:w-48 bg-black/80 border-2 border-zinc-800 focus:border-amber-500/60 rounded-xl px-4 py-4 text-amber-50 focus:outline-none focus:ring-2 focus:ring-amber-500/30 transition-all font-medium appearance-none cursor-pointer" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%270 0 24 24%27 fill=%22none%22 stroke=%22%23fbbf24%22 stroke-width=%272%27 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%276 9 12 15 18 9%27></polyline></svg>'); background-repeat:no-repeat; background-position:right .75rem center; padding-right:2.5rem;">
            <option value="all" {% if search_field == 'all' %}selected{% endif %}>Buscar en todo</option>
            <option value="nombre" {% if search_field == 'nombre' %}selected{% endif %}>Nombre</option>
            <option value="compania" {% if search_field == 'compania' %}selected{% endif %}>Compañía</option>
            <option value="identificacion" {% if search_field == 'identificacion' %}selected{% endif %}>ID</option>
            {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
            <option value="pais" {% if search_field == 'pais' %}selected{% endif %}>Estado</option>
            <option value="telefono" {% if search_field == 'telefono' %}selected{% endif %}>Teléfono</option>
            {% endif %}
          </select>
        </div>

        <div class="relative flex-1 group">
          <input name="q" type="search" placeholder="Buscar cliente..." value="{{ q|default:query|default:'' }}" class="relative w-full bg-black/80 border-2 border-zinc-800 group-focus-within:border-amber-500/60 rounded-xl px-5 py-4 text-amber-50 placeholder-zinc-600 focus:outline-none focus:ring-2 focus:ring-amber-500/30 transition-all font-medium" />
        </div>

        <button type="submit" class="group relative overflow-hidden bg-gradient-to-r from-amber-500 to-amber-600 text-black font-bold py-4 px-6 rounded-xl shadow-lg">Buscar</button>

        {% if q or query %}
        <a href="{% url 'lista_clientes' %}" class="flex items-center justify-center px-6 py-4 bg-zinc-900 hover:bg-zinc-800 border-2 border-amber-500/30 text-amber-400 font-bold rounded-xl transition-all">Limpiar</a>
        {% endif %}
      </div>
    </form>

    {% if q or query %}
    <div class="flex items-center gap-3 bg-amber-500/10 border border-amber-500/30 rounded-xl px-5 py-3 mt-4">
      <svg class="w-5 h-5 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <p class="text-zinc-300 text-sm">Buscando <strong class="text-amber-400">"{{ q|default:query }}"</strong> · <span class="text-amber-400 font-bold">{{ page_obj.paginator.count }}</span> resultados</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Grid de clientes en tarjetas -->
<div class="relative z-10 max-w-7xl mx-auto px-4">
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mt-6">
    {% for cliente in page_obj %}
    <div class="card-hover relative bg-gradient-to-b from-zinc-900/90 to-black/90 backdrop-blur-xl border-2 border-amber-500/30 rounded-3xl overflow-hidden shadow-xl group">
      <div class="absolute top-0 left-0 right-0 h-1.5 bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>

      <div class="relative h-48 bg-black/50 border-b-2 border-amber-500/20 overflow-hidden flex items-center justify-center">
        {% if cliente.logo_url %}
          <img src="{{ cliente.logo_url }}" class="w-full h-full object-contain p-6 group-hover:scale-110 transition-transform duration-500" alt="logo {{ cliente.nombre }}"/>
        {% else %}
          <div class="h-48 flex items-center justify-center bg-black/50 border-b-2 border-amber-500/20">
            <div class="text-center">
              <svg class="w-20 h-20 mx-auto text-amber-500/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <p class="text-zinc-600 font-semibold">Sin logo</p>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="p-6">
        <h5 class="text-2xl font-black text-amber-400 mb-2 leading-tight">{{ cliente.nombre }}</h5>
        <div class="inline-block px-3 py-1 bg-amber-500/10 border border-amber-500/30 rounded-full text-sm font-bold text-amber-400 mb-4">ID: {{ cliente.identificacion }}</div>

        <div class="space-y-3">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <div class="flex-1">
              <span class="text-amber-400 font-bold text-sm">Compañía:</span>
              <p class="text-zinc-200 text-base mt-1">{{ cliente.compania }}</p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 12.414a4 4 0 10-1.414 1.414l4.243 4.243a1 1 0 001.414-1.414z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18a8 8 0 100-16 8 8 0 000 16z"/></svg>
            <div class="flex-1">
              <span class="text-amber-400 font-bold text-sm">Estado:</span>
              <p class="text-zinc-200 text-base mt-1 break-all">{{ cliente.estado_label|default:"No asignado" }}</p>
            </div>
          </div>

          {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            <div class="flex-1">
              <span class="text-amber-400 font-bold text-sm">Teléfono:</span>
              <p class="text-zinc-200 text-base mt-1">{{ cliente.telefono }}</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="px-6 py-4 bg-black/50 border-t border-amber-500/20">
        <div class="flex items-center justify-between">
          <a href="{% url 'detalle_cliente' cliente.pk %}" class="text-amber-400 font-semibold">Ver detalles</a>
          {% if user.is_superuser or user.rol == 'admin' or user.rol == 'superadmin' %}
          <!-- Eliminar: abre modal de confirmación -->
          <button type="button" onclick="document.getElementById('eliminarClienteModal{{ cliente.pk }}').classList.remove('hidden')" class="text-red-500 font-semibold">Eliminar</button>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-20">
      <svg class="w-32 h-32 mx-auto text-amber-500/20 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
      <p class="text-zinc-500 text-xl font-semibold">Aún no hay clientes registrados.</p>
    </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  {% if page_obj.has_other_pages %}
  <div class="flex justify-center items-center gap-2 mt-12">
    {% if page_obj.has_previous %}
    <a href="?page=1{% if q or query %}&q={{ q|default:query }}&field={{ search_field }}{% endif %}" class="px-4 py-2 bg-zinc-900 hover:bg-zinc-800 border-2 border-amber-500/30 text-amber-400 rounded-xl">Primera</a>
    <a href="?page={{ page_obj.previous_page_number }}{% if q or query %}&q={{ q|default:query }}&field={{ search_field }}{% endif %}" class="px-4 py-2 bg-zinc-900 hover:bg-zinc-800 border-2 border-amber-500/30 text-amber-400 rounded-xl">Anterior</a>
    {% endif %}

    <span class="px-6 py-2 bg-amber-500/10 border border-amber-500/30 rounded-xl text-amber-400 font-bold">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if q or query %}&q={{ q|default:query }}&field={{ search_field }}{% endif %}" class="px-4 py-2 bg-zinc-900 hover:bg-zinc-800 border-2 border-amber-500/30 text-amber-400 rounded-xl">Siguiente</a>
    <a href="?page={{ page_obj.paginator.num_pages }}{% if q or query %}&q={{ q|default:query }}&field={{ search_field }}{% endif %}" class="px-4 py-2 bg-zinc-900 hover:bg-zinc-800 border-2 border-amber-500/30 text-amber-400 rounded-xl">Última</a>
    {% endif %}
  </div>
  {% endif %}
</div>

{% endblock %}
